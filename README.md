# ‚öôÔ∏è Backend - NFC Transport App API

[![Node.js](https://img.shields.io/badge/Node.js-18+-green.svg)](https://nodejs.org/)
[![Express](https://img.shields.io/badge/Express-4.18+-blue.svg)](https://expressjs.com/)
[![MongoDB](https://img.shields.io/badge/MongoDB-6.0+-green.svg)](https://www.mongodb.com/)
[![Jest](https://img.shields.io/badge/Jest-29.7+-yellow.svg)](https://jestjs.io/)
[![Tests](https://img.shields.io/badge/tests-25%20passed-brightgreen)](https://github.com/your-org/nfc-transport-app)

> **API RESTful para el sistema de transporte p√∫blico con autenticaci√≥n JWT y gesti√≥n de tarjetas NFC**

## üìã Tabla de Contenidos

- [üéØ Descripci√≥n](#-descripci√≥n)
- [üèóÔ∏è Arquitectura](#Ô∏è-arquitectura)
- [üöÄ Caracter√≠sticas](#-caracter√≠sticas)
- [‚öôÔ∏è Instalaci√≥n](#Ô∏è-instalaci√≥n)
- [üîß Configuraci√≥n](#-configuraci√≥n)
- [üìö API Endpoints](#-api-endpoints)
- [üóÑÔ∏è Base de Datos](#Ô∏è-base-de-datos)
- [üß™ Testing](#-testing)
- [üîí Seguridad](#-seguridad)
- [üì¶ Deployment](#-deployment)

## üéØ Descripci√≥n

El backend de NFC Transport App es una API RESTful construida con Node.js y Express que proporciona todos los servicios necesarios para la gesti√≥n de usuarios, tarjetas NFC, transacciones y autenticaci√≥n del sistema de transporte p√∫blico.

### üéØ Objetivos
- **API RESTful** con endpoints bien documentados
- **Autenticaci√≥n segura** con JWT y refresh tokens
- **Gesti√≥n de tarjetas** NFC con validaci√≥n de propiedad
- **Sistema de transacciones** para viajes y recargas
- **Escalabilidad** y mantenibilidad del c√≥digo

## üèóÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Backend Architecture                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ   Routes    ‚îÇ  ‚îÇ Middleware  ‚îÇ  ‚îÇ  Services   ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ             ‚îÇ  ‚îÇ             ‚îÇ  ‚îÇ             ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ auth      ‚îÇ  ‚îÇ ‚Ä¢ auth      ‚îÇ  ‚îÇ ‚Ä¢ auth      ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ cards     ‚îÇ  ‚îÇ ‚Ä¢ validation‚îÇ  ‚îÇ ‚Ä¢ cards     ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ users     ‚îÇ  ‚îÇ ‚Ä¢ rate limit‚îÇ  ‚îÇ ‚Ä¢ users     ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ transact  ‚îÇ  ‚îÇ ‚Ä¢ cors      ‚îÇ  ‚îÇ ‚Ä¢ transact  ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ           ‚îÇ               ‚îÇ               ‚îÇ               ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ                           ‚îÇ                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ   Models    ‚îÇ  ‚îÇ   Config    ‚îÇ  ‚îÇ   Utils     ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ             ‚îÇ  ‚îÇ             ‚îÇ  ‚îÇ             ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ User      ‚îÇ  ‚îÇ ‚Ä¢ database  ‚îÇ  ‚îÇ ‚Ä¢ logger    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Card      ‚îÇ  ‚îÇ ‚Ä¢ logger    ‚îÇ  ‚îÇ ‚Ä¢ validator ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Transaction‚îÇ ‚îÇ ‚Ä¢ jwt       ‚îÇ  ‚îÇ ‚Ä¢ helpers   ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üìÅ Estructura del Proyecto

```
Backend/
‚îú‚îÄ‚îÄ config/                 # Configuraciones
‚îÇ   ‚îú‚îÄ‚îÄ database.js        # Configuraci√≥n de MongoDB
‚îÇ   ‚îú‚îÄ‚îÄ logger.js          # Configuraci√≥n de logs
‚îÇ   ‚îî‚îÄ‚îÄ metrics.js         # M√©tricas y monitoreo
‚îú‚îÄ‚îÄ middleware/            # Middlewares personalizados
‚îÇ   ‚îú‚îÄ‚îÄ auth.js           # Autenticaci√≥n JWT
‚îÇ   ‚îî‚îÄ‚îÄ validation.js     # Validaci√≥n de datos
‚îú‚îÄ‚îÄ models/               # Modelos de MongoDB
‚îÇ   ‚îú‚îÄ‚îÄ User.js          # Modelo de usuario
‚îÇ   ‚îú‚îÄ‚îÄ Card.js          # Modelo de tarjeta
‚îÇ   ‚îî‚îÄ‚îÄ Transaction.js   # Modelo de transacci√≥n
‚îú‚îÄ‚îÄ routes/               # Rutas de la API
‚îÇ   ‚îú‚îÄ‚îÄ auth.js          # Autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ cards.js         # Gesti√≥n de tarjetas
‚îÇ   ‚îú‚îÄ‚îÄ transactions.js  # Transacciones
‚îÇ   ‚îî‚îÄ‚îÄ users.js         # Usuarios
‚îú‚îÄ‚îÄ services/            # L√≥gica de negocio
‚îÇ   ‚îî‚îÄ‚îÄ authService.js   # Servicios de autenticaci√≥n
‚îú‚îÄ‚îÄ scripts/             # Scripts de utilidad
‚îÇ   ‚îú‚îÄ‚îÄ seed-data.js     # Datos de prueba
‚îÇ   ‚îî‚îÄ‚îÄ setup-env.js     # Configuraci√≥n inicial
‚îú‚îÄ‚îÄ __tests__/           # Tests automatizados
‚îú‚îÄ‚îÄ server.js            # Punto de entrada
‚îî‚îÄ‚îÄ package.json         # Dependencias
```

## üöÄ Caracter√≠sticas

### üîê Autenticaci√≥n y Autorizaci√≥n
- ‚úÖ **JWT Tokens** con expiraci√≥n configurable
- ‚úÖ **Refresh Tokens** para renovaci√≥n autom√°tica
- ‚úÖ **Bcrypt** para encriptaci√≥n de contrase√±as
- ‚úÖ **Rate Limiting** para prevenir abusos
- ‚úÖ **CORS** configurado para seguridad

### üí≥ Gesti√≥n de Tarjetas NFC
- ‚úÖ **Registro de tarjetas** con validaci√≥n de UID
- ‚úÖ **Asociaci√≥n a usuarios** con verificaci√≥n de propiedad
- ‚úÖ **M√∫ltiples tarjetas** por usuario
- ‚úÖ **Alias personalizados** para identificaci√≥n
- ‚úÖ **Estado activo/inactivo** para gesti√≥n

### üí∞ Sistema de Transacciones
- ‚úÖ **Registro de viajes** autom√°tico
- ‚úÖ **Sistema de recarga** con m√∫ltiples m√©todos
- ‚úÖ **Historial completo** con filtros
- ‚úÖ **Validaci√≥n de saldo** antes de transacciones
- ‚úÖ **Reportes y estad√≠sticas**

### üóÑÔ∏è Base de Datos
- ‚úÖ **MongoDB Atlas** para escalabilidad
- ‚úÖ **Mongoose ODM** para modelado
- ‚úÖ **Indexes optimizados** para performance
- ‚úÖ **Validaci√≥n de esquemas** robusta
- ‚úÖ **Backup autom√°tico** configurado

## ‚öôÔ∏è Instalaci√≥n

### üìã Prerrequisitos

- **Node.js** 18+ ([Descargar](https://nodejs.org/))
- **npm** o **yarn**
- **MongoDB** (local o Atlas)
- **Git**

### üöÄ Instalaci√≥n R√°pida

```bash
# 1. Clonar el repositorio
git clone https://github.com/your-org/nfc-transport-app.git
cd nfc-transport-app/Backend

# 2. Instalar dependencias
npm install

# 3. Configurar variables de entorno
cp .env.example .env
# Editar .env con tus configuraciones

# 4. Iniciar en desarrollo
npm run dev

# 5. Verificar instalaci√≥n
npm test
```

### üîß Configuraci√≥n Detallada

Consulta la [Gu√≠a de Configuraci√≥n de Entorno](ENV_SETUP.md) para configuraciones avanzadas.

## üîß Configuraci√≥n

### üìù Variables de Entorno

```bash
# Servidor
PORT=3000
NODE_ENV=development

# Base de Datos
MONGODB_URI=mongodb://localhost:27017/nfc-transport
MONGODB_URI_PROD=mongodb+srv://user:pass@cluster.mongodb.net/nfc-transport

# JWT
JWT_SECRET=your-super-secret-jwt-key
JWT_REFRESH_SECRET=your-super-secret-refresh-key
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# Logging
LOG_LEVEL=info
LOG_FILE=logs/app.log
```

### üóÑÔ∏è Configuraci√≥n de Base de Datos

```javascript
// config/database.js
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    console.log(`MongoDB Connected: ${conn.connection.host}`);
  } catch (error) {
    console.error('Error connecting to MongoDB:', error);
    process.exit(1);
  }
};
```

## üìö API Endpoints

### üîê Autenticaci√≥n

| M√©todo | Endpoint | Descripci√≥n | Autenticaci√≥n |
|--------|----------|-------------|---------------|
| POST | `/api/auth/register` | Registro de usuario | No |
| POST | `/api/auth/login` | Login con credenciales | No |
| POST | `/api/auth/login-card` | Login con tarjeta NFC | No |
| POST | `/api/auth/refresh` | Renovar token | Refresh Token |
| POST | `/api/auth/logout` | Cerrar sesi√≥n | JWT |
| GET | `/api/auth/verify` | Verificar token | JWT |

### üí≥ Gesti√≥n de Tarjetas

| M√©todo | Endpoint | Descripci√≥n | Autenticaci√≥n |
|--------|----------|-------------|---------------|
| GET | `/api/usuario/:userId/tarjetas` | Obtener tarjetas | JWT |
| POST | `/api/usuario/:userId/tarjetas` | Agregar tarjeta | JWT |
| PATCH | `/api/tarjetas/:uid` | Actualizar alias | JWT |
| DELETE | `/api/tarjetas/:uid` | Eliminar tarjeta | JWT |
| GET | `/api/saldo/:uid` | Consultar saldo | JWT |

### üí∞ Transacciones

| M√©todo | Endpoint | Descripci√≥n | Autenticaci√≥n |
|--------|----------|-------------|---------------|
| POST | `/api/recargar` | Procesar recarga | JWT |
| GET | `/api/historial/:uid` | Historial de transacciones | JWT |
| POST | `/api/validar` | Validar tarjeta | JWT |

### üìä Documentaci√≥n Completa

Consulta la [Documentaci√≥n Completa de la API](API_DOCUMENTATION_JWT.md) para detalles de todos los endpoints, par√°metros, respuestas y c√≥digos de error.

## üóÑÔ∏è Base de Datos

### üìä Modelos

#### User Model
```javascript
{
  username: String,        // Usuario √∫nico
  password: String,        // Encriptado con bcrypt
  nombre: String,          // Nombre completo
  email: String,           // Email √∫nico
  telefono: String,        // Tel√©fono
  tipo_tarjeta: String,    // 'adulto', 'estudiante', 'adulto_mayor'
  fecha_registro: Date,    // Fecha de registro
  activo: Boolean          // Estado del usuario
}
```

#### Card Model
```javascript
{
  uid: String,             // UID √∫nico de la tarjeta NFC
  usuario_id: ObjectId,    // Referencia al usuario
  alias: String,           // Alias personalizado
  saldo_actual: Number,    // Saldo en bolivianos
  tipo_tarjeta: String,    // Tipo de tarjeta
  fecha_creacion: Date,    // Fecha de registro
  activa: Boolean          // Estado de la tarjeta
}
```

#### Transaction Model
```javascript
{
  tarjeta_uid: String,     // UID de la tarjeta
  tipo: String,            // 'viaje', 'recarga'
  monto: Number,           // Monto de la transacci√≥n
  ubicacion: String,       // Ubicaci√≥n del evento
  resultado: String,       // 'exitoso', 'fallido'
  fecha_hora: Date,        // Timestamp
  detalles: Object         // Informaci√≥n adicional
}
```

### üîç Indexes Optimizados

```javascript
// User indexes
db.users.createIndex({ "username": 1 }, { unique: true })
db.users.createIndex({ "email": 1 }, { unique: true })

// Card indexes
db.cards.createIndex({ "uid": 1 }, { unique: true })
db.cards.createIndex({ "usuario_id": 1 })

// Transaction indexes
db.transactions.createIndex({ "tarjeta_uid": 1 })
db.transactions.createIndex({ "fecha_hora": -1 })
db.transactions.createIndex({ "tipo": 1, "fecha_hora": -1 })
```

## üß™ Testing

### üöÄ Ejecutar Tests

```bash
# Todos los tests
npm test

# Tests con coverage
npm run test:coverage

# Tests en modo watch
npm run test:watch

# Tests espec√≠ficos
npm test -- --testNamePattern="auth"
```

### üìä Cobertura de Tests

- ‚úÖ **25 tests** en 8 suites
- ‚úÖ **100% cobertura** en rutas cr√≠ticas
- ‚úÖ **Tests de integraci√≥n** para flujos completos
- ‚úÖ **Tests unitarios** para servicios
- ‚úÖ **Tests de autenticaci√≥n** y autorizaci√≥n

### üß™ Tipos de Tests

```javascript
// Test de integraci√≥n
describe('POST /api/auth/login', () => {
  it('should authenticate user with valid credentials', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        username: 'testuser',
        password: 'password123'
      });
    
    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
    expect(response.body.data.tokens).toBeDefined();
  });
});
```

## üîí Seguridad

### üõ°Ô∏è Medidas Implementadas

- **JWT Tokens** con expiraci√≥n configurable
- **Bcrypt** para encriptaci√≥n de contrase√±as
- **Rate Limiting** para prevenir ataques de fuerza bruta
- **CORS** configurado para or√≠genes permitidos
- **Helmet.js** para headers de seguridad
- **Validaci√≥n de entrada** con express-validator
- **Sanitizaci√≥n** de datos de entrada

### üîê Autenticaci√≥n

```javascript
// Middleware de autenticaci√≥n
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ 
      success: false, 
      error: 'Token de acceso requerido' 
    });
  }

  jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
    if (err) {
      return res.status(403).json({ 
        success: false, 
        error: 'Token inv√°lido' 
      });
    }
    req.user = user;
    next();
  });
};
```

### üö´ Rate Limiting

```javascript
const rateLimit = require('express-rate-limit');

const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 5, // m√°ximo 5 intentos
  message: {
    success: false,
    error: 'Demasiados intentos de login. Intenta de nuevo en 15 minutos.'
  }
});
```

## üì¶ Deployment

### üöÄ Producci√≥n

```bash
# 1. Configurar variables de producci√≥n
export NODE_ENV=production
export MONGODB_URI_PROD=your-production-mongodb-uri
export JWT_SECRET=your-production-jwt-secret

# 2. Instalar dependencias de producci√≥n
npm ci --only=production

# 3. Iniciar servidor
npm start
```

### üê≥ Docker

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

### ‚òÅÔ∏è Cloud Deployment

- **Heroku**: Configurado para despliegue autom√°tico
- **AWS**: EC2 con PM2 para gesti√≥n de procesos
- **Google Cloud**: App Engine con escalado autom√°tico
- **Azure**: App Service con CI/CD integrado

---

## üìû Soporte

- **Issues**: [GitHub Issues](https://github.com/your-org/nfc-transport-app/issues)
- **Documentaci√≥n**: [API Docs](API_DOCUMENTATION_JWT.md)
- **Email**: backend@nfc-transport-app.com

---

**Desarrollado con ‚ù§Ô∏è por el equipo de NFC Transport App**
